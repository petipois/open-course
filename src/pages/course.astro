---
import MainLayout from "@/layouts/MainLayout.astro";
import LessonList from "@/components/LessonList.astro";
import LessonPlayer from "@/components/LessonPlayer.astro";
import { getLessons, getLessonProgress } from "@/lib/appwrite";
import { showCourseDetails } from "@/lib/helper";

const user = await Astro.locals.currentUser();
if (!user) throw Astro.redirect("/login");

const course = await showCourseDetails();
const lessons = await getLessons(course?.$id) || [];

// Track progress for each lesson
let lessonProgress: { [key: string]: boolean } = {};
for (const lesson of lessons) {
  const progress = await getLessonProgress(user.id, lesson.$id);
  lessonProgress[lesson.$id] = Boolean(progress && progress.length > 0);
}
---
<MainLayout>
  <div class="flex min-h-screen bg-gray-50">
    <LessonList lessons={lessons} lessonProgress={lessonProgress} />
    <main class="flex-1 px-10 py-8">
      <LessonPlayer lessons={lessons} user={user} courseID={course?.$id} />
    </main>
  </div>
</MainLayout>
